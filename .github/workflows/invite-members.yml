name: Invite Members From Online Excel

on:
  workflow_dispatch:

jobs:
  invite:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---- Download Excel directly from SharePoint link ----
      - name: Download Excel
        run: |
          curl -L -o members.xlsx "${{ secrets.EXCEL_DOWNLOAD_URL }}"

          
      - name: Print first lines of downloaded file (debug)
        run: head -n 20 members.xlsx

      # ---- Convert XLSX → CSV ----
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: pip install pandas openpyxl

      - name: Debug file
        run: |
          file members.xlsx
          ls -lh members.xlsx

      - name: Convert XLSX to CSV
        run: |
          python3 - << 'EOF'
          import pandas as pd

          df = pd.read_excel("members.xlsx", engine="openpyxl")

          df = df.rename(columns={
              df.columns[5]: "GITHUB_ACCOUNT", 
              df.columns[7]: "PASS"     
          })

          df.to_csv("members.csv", index=False)
          EOF

      # ---- Run Node script to invite users ----
      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Node modules
        run: npm install csv-parser axios

      - name: Invite Users
        env:
          GITHUB_TOKEN: ${{ secrets.ORG_ADMIN_PAT }}
          ORG_NAME: raquelscmb
        run: |
          node - << 'EOF'
          const fs = require("fs");
          const csv = require("csv-parser");
          const axios = require("axios");

          const org = process.env.ORG_NAME;
          const token = process.env.GITHUB_TOKEN;

          async function invite(username) {
            try {
              await axios.post(
                `https://api.github.com/orgs/${org}/invitations`,
                { email: null, role: "direct_member" },
                {
                  headers: {
                    Authorization: `Bearer ${token}`,
                    Accept: "application/vnd.github+json",
                    "X-GitHub-Username": username
                  }
                }
              );
              console.log(`✔ Invited: ${username}`);
            } catch (err) {
              console.error(`❌ Failed: ${username}`, err.response?.data);
            }
          }

          fs.createReadStream("members.csv")
            .pipe(csv())
            .on("data", async (row) => {
              const username = row.username?.trim();
              const status = row.status?.toLowerCase();

              if (!username) return;
              if (status === "TRUE") {
                await invite(username);
              } else {
                console.log(`Skipping (Failed): ${username}`);
              }
            });
          EOF
